trigger:
  batch: False
  branches:
    include:
      - '*'
pr:
  branches:
    include:
      - '*'

jobs:
- job:
  displayName: Windows
  pool:
    vmImage: 'vs2017-win2016'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python38:
        python.version: '3.8'

  steps:
  - script: |
      call "%CONDA%\Scripts\activate" base
      echo "##vso[task.setvariable variable=PATH]%CONDA%\Scripts;%PATH%"
    displayName: Add conda to PATH and activate conda base
  - script: conda install python=%PYTHON_VERSION% ipython numpy seaborn statsmodels matplotlib sphinx pillow pytest pytest-cov sphinx_rtd_theme joblib plotly
    displayName: Setup conda environment
  - script: python setup.py develop
    displayName: Install sphinx-gallery
  - script: pytest --tb=short sphinx_gallery
    displayName: pytest
  - script: |
      cd doc
      sphinx-build -D plot_gallery=0 -b html -d _build\doctrees . _build\html
    displayName: make html-noplot
  - bash: |
      cd doc
      make clean
    displayName: make clean
  - script: |
      cd doc
      sphinx-build -b html -d _build\doctrees . _build\html
    displayName: make html
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit-*.xml'
      testRunTitle: 'Publish test results for $(Agent.JobName) $(TEST_MODE) $(PYTHON_VERSION)'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()

- job:
  displayName: Linux
  pool:
    vmImage: 'ubuntu-18.04'
  strategy:
    matrix:
      ubuntu_python36:
        DISTRIB: 'ubuntu'
        PYTHON_VERSION: '3.6'
      conda_python35:
        DISTRIB: 'conda'
        PYTHON_VERSION: '3.5'
        SPHINX_VERSION: '1.8.3'
      conda_python36:
        DISTRIB: 'conda'
        PYTHON_VERSION: '3.6'
      conda_python36_localeC:
        DISTRIB: 'conda'
        PYTHON_VERSION: '3.6'
        LOCALE: 'C'
      conda_python37_localeC:
        DISTRIB: 'conda'
        PYTHON_VERSION: '3.7'
        LOCALE: 'C'
        SPHINXOPTS: '-nWT --keep-going'
      conda_python38_sphinxDev:
        DISTRIB: 'conda'
        PYTHON_VERSION: '3.8'
        SPHINX_VERSION: 'dev'
      python37_minimal:
        DISTRIB: 'minimal'
        PYTHON_VERSION: '3.7'
      # pythonNightly:
      #   DISTRIB: 'Nightly'

  steps:
  - task: UsePythonVersion@0
    displayName: Specify Python version for minimal
    inputs:
      versionSpec: $(PYTHON_VERSION)
    condition: eq(variables['DISTRIB'], 'minimal')
  - bash: |
      export LC_CTYPE=C
      export LC_ALL=C
      export LANG=C
    displayName: Set locale
    condition: eq(variables['LOCALE'], 'C')
    # Make sure that things work even if the locale is set to C (which
    # effectively means ASCII). Some of the input rst files have unicode
    # characters and we need to deal with this gracefully.
  - bash: |
      sudo apt-get install python3-numpy python3-matplotlib python3-pip python3-coverage optipng
    displayName: Install ubuntu python for ubuntu
    condition: eq(variables['DISTRIB'], 'ubuntu')
  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
    condition: eq(variables['DISTRIB'], 'conda')
  - task: Bash@3
    inputs:
      filePath: continuous_integration/azure/install.sh
    displayName: Run install.sh
